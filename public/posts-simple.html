<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Posts (Simple)</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>
  <h1>ðŸ“š Blog Posts</h1>
  <p class="muted">Client-side list (fetch + JSON API).</p>
  <div id="status" class="loading">Loadingâ€¦</div>
  <ul id="list"></ul>

  <script>
    const SAME_PORT = location.port === '3000';
    const API_BASE = SAME_PORT ? '' : `${location.protocol}//${location.hostname}:3000`;
    const URL = `${API_BASE}/api/posts`;
    const listEl = document.getElementById('list');
    const statusEl = document.getElementById('status');

    async function load() {
      statusEl.textContent = `Loading from ${URL} ...`;
      listEl.innerHTML = '';
      try {
        const res = await fetch(URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (data.count === 0) {
          statusEl.textContent = 'No posts.';
          return;
        }
        statusEl.textContent = `Loaded ${data.count} posts.`;
        data.posts.forEach(p => {
          const li = document.createElement('li');
          // Prefer server-rendered route only when actually running on the Express app (port 3000)
          const onServer3000 = (location.protocol.startsWith('http') && location.port === '3000');
          const href = onServer3000 ? p.url : `post.html?id=${encodeURIComponent(p.id)}`;
          li.innerHTML = `<a href='${href}'>${p.title}</a>` +
            (p.summary ? `<div class='muted'>${p.summary}</div>` : '');
          listEl.appendChild(li);
        });
      } catch (err) {
        statusEl.innerHTML = `<div class='error'>Failed to load from <code>${URL}</code><br>${err.message}<br><small>Is the server running (npm run server)?</small></div>`;
      }
    }

    load();
  </script>
</body>

</html>